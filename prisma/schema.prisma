generator client {
  provider = "prisma-client-js"
}

// PRODUCTION GUARDRAIL: Never edit applied migration files in prisma/migrations/.
// To change the schema, create a NEW migration with `npx prisma migrate dev`.
// Applied migrations are immutable records of the database history.

datasource db {
  provider = "postgresql"
}

model User {
  id        String    @id @default(uuid())
  name      String?
  email     String    @unique
  password  String
  role      String    @default("DOCTOR")
  createdAt DateTime  @default(now())
  patients  Patient[]
}

model Option {
  id       String @id @default(uuid())
  category String
  label    String
  value    String
  order    Int    @default(0)
}

model Patient {
  id              String        @id @default(uuid())
  name            String
  age             Int
  createdBy       String
  createdAt       DateTime      @default(now())
  address         String
  dateOfBirth     DateTime
  district        String
  ethnicity       String
  familyHistory   String?
  finalDiagnosis  String?
  mobile          String
  nid             String?
  pastIllness     String?
  patientId       String?       @unique
  relativeMobile  String?
  religion        String        @default("Islam")
  shortHistory    String?
  specialNotes    String?
  spouseMobile    String?
  surgicalHistory String?
  tags            String[]      @default([])
  createdByUser   User          @relation(fields: [createdBy], references: [id])
  tests           PatientTest[]

  @@index([name])
  @@index([mobile])
  @@index([patientId])
  @@index([finalDiagnosis])
  @@index([relativeMobile])
  @@index([spouseMobile])
  // GIN index for array field — enables fast `has` lookups on tags
  @@index([tags], type: Gin)
  // Composite index for default sort order (createdAt DESC) used by list queries
  @@index([createdAt(sort: Desc)])
}

model PatientTest {
  id                String   @id @default(uuid())
  patientId         String?
  sampleDate        DateTime
  autoimmunoProfile Json?
  cardiology        Json?
  rft               Json?
  lft               Json?
  diseaseHistory    Json?
  imaging           Json?
  hematology        Json?
  basdai            Json?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  // DESTRUCTIVE: onDelete: Cascade — deleting a Patient removes ALL related
  // PatientTest rows automatically. This is intentional for data integrity
  // but cannot be undone. Ensure UI confirms before triggering delete.
  patient           Patient? @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([sampleDate])
  @@index([createdAt])
  @@index([patientId, createdAt])
}
